var RESULT={HIT:0,MISS:1,DODGE:2,CRIT:3,GLANCE:4},batching=0,step=0,log=!0,version=4;const TYPE={UPDATE:0,FINISHED:1,ERROR:2};class SimulationWorker{constructor(e,t,s){this.worker=new Worker("./dist/js/sim-worker.min.js"),this.worker.onerror=((...e)=>{s(...e),this.worker.terminate()}),this.worker.onmessage=(a=>{const[i,...l]=a.data;switch(i){case TYPE.UPDATE:t(...l);break;case TYPE.FINISHED:e(...l),this.worker.terminate();break;case TYPE.ERROR:s(...l),this.worker.terminate();break;default:s(`Unexpected type: ${i}`),this.worker.terminate()}})}start(e){e.globals=getGlobalsDelta(),this.worker.postMessage(e)}}class SimulationWorkerParallel{constructor(e,t,s,a){this.threads=e,this.callback_finished=t,this.callback_update=s,this.states=[...Array(this.threads)],this.workers=this.states.map((e,t)=>new SimulationWorker(e=>{this.states[t]={status:1,data:e},this.update()},(e,s)=>{this.states[t]={status:0,iteration:e,data:s},this.update()},e=>{this.error||(this.error=e,a(e))}))}update(){if(this.error)return;if(this.states.reduce((e,t)=>e+(t&&t.status||0),0)>=this.states.length){const e=this.states[0].data;this.states.slice(1).forEach(({data:t})=>{if(e.iterations+=t.iterations,e.totaldmg+=t.totaldmg,e.totalduration+=t.totalduration,e.mindps=Math.min(e.mindps,t.mindps),e.maxdps=Math.min(e.maxdps,t.maxdps),e.sumdps+=t.sumdps,e.sumdps2+=t.sumdps2,e.starttime=Math.min(e.starttime,t.starttime),e.endtime=Math.min(e.endtime,t.endtime),e.spread&&t.spread)for(let s in t.spread)e.spread[s]=(e.spread[s]||0)+t.spread[s];if(e.player&&t.player){for(let s in t.player.auras){const a=t.player.auras[s],i=e.player.auras[s];i?(i.uptime+=a.uptime,a.totaldmg&&(i.totaldmg=(i.totaldmg||0)+a.totaldmg)):e.player.auras[s]=a}for(let s in t.player.spells){const a=t.player.spells[s],i=e.player.spells[s];if(i){i.totaldmg+=a.totaldmg;for(let e=0;e<a.data.length;++e)i.data[e]+=a.data[e]}else e.player.spells[s]=a}function s(e,t){if(e){e.totaldmg+=t.totaldmg,e.totalprocdmg+=t.totalprocdmg;for(let s=0;s<t.data.length;++s)e.data[s]+=t.data[s];return e}return t}e.player.mh=s(e.player.mh,t.player.mh),t.player.oh&&(e.player.oh=s(e.player.oh,t.player.oh))}}),this.callback_finished(e)}else{let e=0;const t={iterations:this.iterations,totaldmg:0,totalduration:0};this.states.forEach(s=>{s&&(e+=s.status?s.data.iterations:s.iteration,t.totaldmg+=s.data.totaldmg,t.totalduration+=s.data.totalduration)}),this.callback_update(e,t)}}start(e){e.globals=getGlobalsDelta(),this.iterations=e.sim.iterations;let t=e.sim.iterations;this.workers.forEach((s,a)=>{const i=Math.round(t/(this.workers.length-a));t-=i,s.start({...e,sim:{...e.sim,iterations:i}})})}}class Simulation{static getConfig(){return{timesecsmin:parseInt($('input[name="timesecsmin"]').val()),timesecsmax:parseInt($('input[name="timesecsmax"]').val()),executeperc:parseInt($('input[name="executeperc"]').val()),startrage:parseInt($('input[name="startrage"]').val()),iterations:parseInt($('input[name="simulations"]').val()),priorityap:parseInt(spells[4].priorityap),batching:parseInt($('select[name="batching"]').val())}}constructor(e,t,s,a){a||(a=Simulation.getConfig()),this.player=e,this.timesecsmin=a.timesecsmin,this.timesecsmax=a.timesecsmax,this.executeperc=a.executeperc,this.startrage=a.startrage,this.iterations=a.iterations,batching=a.batching,this.idmg=0,this.totaldmg=0,this.totalduration=0,this.mindps=99999,this.maxdps=0,this.sumdps=0,this.sumdps2=0,this.maxcallstack=Math.min(Math.floor(this.iterations/10),1e3),this.starttime=0,this.endtime=0,this.cb_update=s,this.cb_finished=t,this.spread=[],this.priorityap=parseInt(spells[4].priorityap),log=1==this.iterations}startSync(){let e;for(this.starttime=(new Date).getTime(),e=1;e<=this.iterations;++e)this.run(),e%this.maxcallstack==0&&this.update(e);this.endtime=(new Date).getTime(),this.finished()}startAsync(){this.starttime=(new Date).getTime(),this.runAsync(1)}runAsync(e){this.run(),e==this.iterations?(this.endtime=(new Date).getTime(),this.finished()):e%this.maxcallstack==0?(this.update(e),setTimeout(()=>this.runAsync(e+1),0)):this.runAsync(e+1)}run(){step=0,this.idmg=0;let e,t,s=this.player;s.reset(this.startrage),this.maxsteps=rng(1e3*this.timesecsmin,1e3*this.timesecsmax),this.duration=this.maxsteps/1e3,this.executestep=this.maxsteps-parseInt(this.maxsteps*(this.executeperc/100));let a=!1,i=0,l=0;for(s.auras.slayer&&(this.slayerstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),s.auras.spider&&(this.spiderstep=Math.max(this.maxsteps-l-15e3,0),l+=15e3),s.auras.bloodlustbrooch&&(this.broochstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),s.auras.pummeler&&(this.pummelstep=Math.max(this.maxsteps-l-3e4,0),l+=3e4),s.auras.swarmguard&&(s.auras.swarmguard.usestep=Math.max(this.maxsteps-s.auras.swarmguard.timetoend,0)),log&&console.log(" TIME |   RAGE | EVENT");step<this.maxsteps;)if(s.mh.timer<=0&&(this.idmg+=s.attackmh(s.mh),a=!0),a&&!s.spelldelay&&(s.auras.swarmguard&&s.auras.swarmguard.canUse()?(s.spelldelay=1,e=s.auras.swarmguard):s.auras.slayer&&s.auras.slayer.canUse()&&step>this.slayerstep?(s.spelldelay=1,e=s.auras.slayer):s.auras.spider&&s.auras.spider.canUse()&&step>this.spiderstep?(s.spelldelay=1,e=s.auras.spider):s.auras.bloodlustbrooch&&s.auras.bloodlustbrooch.canUse()&&step>this.brooochstep?(s.spelldelay=1,e=s.auras.bloodlustbrooch):s.auras.pummeler&&s.auras.pummeler.canUse()&&step>this.pummelstep?(s.spelldelay=1,e=s.auras.pummeler):s.spells.faeriefire&&s.spells.faeriefire.canUse()?(s.spelldelay=1,e=s.spells.faeriefire):s.spells.mangle&&s.spells.mangle.canUse()?(s.spelldelay=1,e=s.spells.mangle):s.spells.lacerate&&s.spells.lacerate.canUse()?(s.spelldelay=1,e=s.spells.lacerate):s.spells.swipe&&s.spells.swipe.canUse()&&(s.spelldelay=1,e=s.spells.swipe),log&&s.spelldelay&&s.log(`Preparing ${e.name}`),s.heroicdelay&&(a=!1)),a&&!s.heroicdelay&&(s.spells.maul&&s.spells.maul.canUse()&&(s.heroicdelay=1,t=s.spells.maul),log&&s.heroicdelay&&s.log(`Preparing ${t.name}`),a=!1),s.spelldelay&&e&&s.spelldelay>e.maxdelay&&(s.heroicdelay&&t&&s.heroicdelay>t.maxdelay&&(s.heroicdelay=t.maxdelay-49),e.canUse()?(this.idmg+=s.cast(e),s.spelldelay=0,a=!0):s.spelldelay=0),s.heroicdelay&&t&&s.heroicdelay>t.maxdelay&&(t.canUse()?(s.cast(t),s.heroicdelay=0,a=!0):s.heroicdelay=0),!s.mh.timer||!s.spelldelay&&a||!s.heroicdelay&&a)i=0;else{if(i=s.mh.timer,s.spelldelay&&e.maxdelay-s.spelldelay<i&&(i=e.maxdelay-s.spelldelay+1),s.heroicdelay&&t.maxdelay-s.heroicdelay<i&&(i=t.maxdelay-s.heroicdelay+1),s.timer&&s.timer<i&&(i=s.timer),s.itemtimer&&s.itemtimer<i&&(i=s.itemtimer),s.spells.mangle&&s.spells.mangle.timer&&s.spells.mangle.timer<i&&(i=s.spells.mangle.timer),s.spells.lacerate&&s.spells.lacerate.timer&&s.spells.lacerate.timer<i&&(i=s.spells.lacerate.timer),s.spells.swipe&&s.spells.swipe.timer&&s.spells.swipe.timer<i&&(i=s.spells.swipe.timer),0==i)break;step+=i,s.mh.step(i),s.timer&&s.steptimer(i)&&!s.spelldelay&&(a=!0),s.itemtimer&&s.stepitemtimer(i)&&!s.spelldelay&&(a=!0),s.dodgetimer&&s.stepdodgetimer(i),s.spelldelay&&(s.spelldelay+=i),s.heroicdelay&&(s.heroicdelay+=i),s.spells.mangle&&s.spells.mangle.timer&&!s.spells.mangle.step(i)&&!s.spelldelay&&(a=!0),s.spells.lacerate&&s.spells.lacerate.timer&&!s.spells.lacerate.step(i)&&!s.spelldelay&&(a=!0),s.spells.swipe&&s.spells.swipe.timer&&!s.spells.swipe.step(i)&&!s.spelldelay&&(a=!0)}s.endauras(),s.auras.LacerateDOT&&(this.idmg+=s.auras.deepwounds.idmg),this.totaldmg+=this.idmg,this.totalduration+=this.duration;let r=this.idmg/this.duration;r<this.mindps&&(this.mindps=r),r>this.maxdps&&(this.maxdps=r),this.sumdps+=r,this.sumdps2+=r*r,r=Math.round(r),this.spread[r]?this.spread[r]++:this.spread[r]=1}update(e){this.cb_update&&this.cb_update(e,{iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration})}finished(){this.cb_finished&&this.cb_finished({iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration,mindps:this.mindps,maxdps:this.maxdps,sumdps:this.sumdps,sumdps2:this.sumdps2,starttime:this.starttime,endtime:this.endtime})}}function rng(e,t){return~~(Math.random()*(t-e+1)+e)}function rng10k(){return~~(1e4*Math.random())}function avg(e,t){return(e+t)/2}